#!/bin/bash

# docker compose
curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

# get installation
git clone https://postalserver.io/start/install /opt/postal/install
ln -s /opt/postal/install/bin/postal /usr/bin/postal

#head /dev/urandom | tr -dc A-Za-z0-9 | head -c10 >> ~/pass.txt
password=`perl -e "use NethServer::Password; print NethServer::Password::store('postal');"`

# Create dirs for volumes
mkdir -p /opt/postal/mariadb
mkdir -p /opt/postal/rabbitmq

# Run rabbitmq container
docker run -d \
   --name postal-rabbitmq \
   -v /opt/postal/rabbitmq:/var/lib/rabbitmq \
   -p 127.0.0.1:5672:5672 \
   --restart always \
   -e RABBITMQ_DEFAULT_USER=postal \
   -e RABBITMQ_DEFAULT_PASS=$password \
   -e RABBITMQ_DEFAULT_VHOST=postal \
   rabbitmq:3.8

# Run mariadb container
docker run -d \
   --name postal-mariadb \
   -v /opt/postal/mariadb:/var/lib/mysql \
   -p 127.0.0.1:3307:3306 \
   --restart always \
   -e MARIADB_DATABASE=postal \
   -e MARIADB_ROOT_PASSWORD=$password \
   mariadb

# dirty hack to be able to access docker containers like postal-mariadb
signal-event firewall-adjust

#Use custom virtualhost name or Nethserver domain name
domain=`config getprop postal VirtualHost`
if [[ $domain = '' ]]; then domain=`config get DomainName`; fi

# Bootstrap Postal - maybe only do it once?
postal bootstrap postal.$domain

# Initialize postal - on error initialize again
postal initialize
